#include "font.h"
#include "render.h"
#include <stdarg.h>
#include <stdio.h>
#include <string.h>

/* ============================================================
 * Embedded 8x8 Bitmap Font Data
 * ============================================================
 * Each character is 8 bytes, one byte per row.
 * Bit 7 = leftmost pixel, bit 0 = rightmost pixel.
 * Covers ASCII 32 (space) through 126 (~).
 * ============================================================ */
static const uint8_t s_font_data[FONT_CHAR_COUNT][FONT_CHAR_HEIGHT] = {
    /* 32 ' ' */ {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 33 '!' */ {0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00},
    /* 34 '"' */ {0x6C, 0x6C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 35 '#' */ {0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00},
    /* 36 '$' */ {0x18, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x18, 0x00},
    /* 37 '%' */ {0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00, 0x00},
    /* 38 '&' */ {0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00},
    /* 39 ''' */ {0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 40 '(' */ {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},
    /* 41 ')' */ {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},
    /* 42 '*' */ {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},
    /* 43 '+' */ {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},
    /* 44 ',' */ {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},
    /* 45 '-' */ {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
    /* 46 '.' */ {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    /* 47 '/' */ {0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x00, 0x00},
    /* 48 '0' */ {0x7C, 0xCE, 0xDE, 0xF6, 0xE6, 0xC6, 0x7C, 0x00},
    /* 49 '1' */ {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    /* 50 '2' */ {0x7C, 0xC6, 0x06, 0x1C, 0x70, 0xC6, 0xFE, 0x00},
    /* 51 '3' */ {0x7C, 0xC6, 0x06, 0x3C, 0x06, 0xC6, 0x7C, 0x00},
    /* 52 '4' */ {0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x1E, 0x00},
    /* 53 '5' */ {0xFE, 0xC0, 0xFC, 0x06, 0x06, 0xC6, 0x7C, 0x00},
    /* 54 '6' */ {0x38, 0x60, 0xC0, 0xFC, 0xC6, 0xC6, 0x7C, 0x00},
    /* 55 '7' */ {0xFE, 0xC6, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00},
    /* 56 '8' */ {0x7C, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0x7C, 0x00},
    /* 57 '9' */ {0x7C, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0x78, 0x00},
    /* 58 ':' */ {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00},
    /* 59 ';' */ {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30},
    /* 60 '<' */ {0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x00},
    /* 61 '=' */ {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00},
    /* 62 '>' */ {0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x00},
    /* 63 '?' */ {0x7C, 0xC6, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00},
    /* 64 '@' */ {0x7C, 0xC6, 0xDE, 0xDE, 0xDC, 0xC0, 0x7C, 0x00},
    /* 65 'A' */ {0x38, 0x6C, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0x00},
    /* 66 'B' */ {0xFC, 0xC6, 0xC6, 0xFC, 0xC6, 0xC6, 0xFC, 0x00},
    /* 67 'C' */ {0x7C, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x7C, 0x00},
    /* 68 'D' */ {0xF8, 0xCC, 0xC6, 0xC6, 0xC6, 0xCC, 0xF8, 0x00},
    /* 69 'E' */ {0xFE, 0xC0, 0xC0, 0xFC, 0xC0, 0xC0, 0xFE, 0x00},
    /* 70 'F' */ {0xFE, 0xC0, 0xC0, 0xFC, 0xC0, 0xC0, 0xC0, 0x00},
    /* 71 'G' */ {0x7C, 0xC6, 0xC0, 0xCE, 0xC6, 0xC6, 0x7E, 0x00},
    /* 72 'H' */ {0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00},
    /* 73 'I' */ {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    /* 74 'J' */ {0x1E, 0x06, 0x06, 0x06, 0xC6, 0xC6, 0x7C, 0x00},
    /* 75 'K' */ {0xC6, 0xCC, 0xD8, 0xF0, 0xD8, 0xCC, 0xC6, 0x00},
    /* 76 'L' */ {0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFE, 0x00},
    /* 77 'M' */ {0xC6, 0xEE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0x00},
    /* 78 'N' */ {0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00},
    /* 79 'O' */ {0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    /* 80 'P' */ {0xFC, 0xC6, 0xC6, 0xFC, 0xC0, 0xC0, 0xC0, 0x00},
    /* 81 'Q' */ {0x7C, 0xC6, 0xC6, 0xC6, 0xD6, 0xDE, 0x7C, 0x06},
    /* 82 'R' */ {0xFC, 0xC6, 0xC6, 0xFC, 0xD8, 0xCC, 0xC6, 0x00},
    /* 83 'S' */ {0x7C, 0xC6, 0xC0, 0x7C, 0x06, 0xC6, 0x7C, 0x00},
    /* 84 'T' */ {0xFE, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    /* 85 'U' */ {0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    /* 86 'V' */ {0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x10, 0x00},
    /* 87 'W' */ {0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00},
    /* 88 'X' */ {0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00},
    /* 89 'Y' */ {0xC6, 0xC6, 0x6C, 0x38, 0x18, 0x18, 0x18, 0x00},
    /* 90 'Z' */ {0xFE, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFE, 0x00},
    /* 91 '[' */ {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},
    /* 92 '\' */ {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x00, 0x00},
    /* 93 ']' */ {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},
    /* 94 '^' */ {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},
    /* 95 '_' */ {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x00},
    /* 96 '`' */ {0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 97 'a' */ {0x00, 0x00, 0x7C, 0x06, 0x7E, 0xC6, 0x7E, 0x00},
    /* 98 'b' */ {0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0xFC, 0x00},
    /* 99 'c' */ {0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC6, 0x7C, 0x00},
    /* 100 'd' */ {0x06, 0x06, 0x7E, 0xC6, 0xC6, 0xC6, 0x7E, 0x00},
    /* 101 'e' */ {0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0x7C, 0x00},
    /* 102 'f' */ {0x1C, 0x36, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x00},
    /* 103 'g' */ {0x00, 0x00, 0x7E, 0xC6, 0xC6, 0x7E, 0x06, 0x7C},
    /* 104 'h' */ {0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0xC6, 0x00},
    /* 105 'i' */ {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00},
    /* 106 'j' */ {0x06, 0x00, 0x0E, 0x06, 0x06, 0xC6, 0xC6, 0x7C},
    /* 107 'k' */ {0xC0, 0xC0, 0xC6, 0xCC, 0xF8, 0xCC, 0xC6, 0x00},
    /* 108 'l' */ {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    /* 109 'm' */ {0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xD6, 0xC6, 0x00},
    /* 110 'n' */ {0x00, 0x00, 0xFC, 0xC6, 0xC6, 0xC6, 0xC6, 0x00},
    /* 111 'o' */ {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    /* 112 'p' */ {0x00, 0x00, 0xFC, 0xC6, 0xC6, 0xFC, 0xC0, 0xC0},
    /* 113 'q' */ {0x00, 0x00, 0x7E, 0xC6, 0xC6, 0x7E, 0x06, 0x06},
    /* 114 'r' */ {0x00, 0x00, 0xDC, 0xE6, 0xC0, 0xC0, 0xC0, 0x00},
    /* 115 's' */ {0x00, 0x00, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x00},
    /* 116 't' */ {0x30, 0x30, 0x7C, 0x30, 0x30, 0x36, 0x1C, 0x00},
    /* 117 'u' */ {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0x7E, 0x00},
    /* 118 'v' */ {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00},
    /* 119 'w' */ {0x00, 0x00, 0xC6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00},
    /* 120 'x' */ {0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00},
    /* 121 'y' */ {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x7C},
    /* 122 'z' */ {0x00, 0x00, 0xFE, 0x0C, 0x38, 0x60, 0xFE, 0x00},
    /* 123 '{' */ {0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00},
    /* 124 '|' */ {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    /* 125 '}' */ {0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00},
    /* 126 '~' */ {0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

/* Static state */
static int s_initialized = 0;

/* Formatting buffer for printf functions */
#define FONT_PRINTF_BUFFER_SIZE 256
static char s_printf_buffer[FONT_PRINTF_BUFFER_SIZE];

/* ============================================================
 * Initialize Font Subsystem
 * ============================================================ */
int font_init(void)
{
    if (s_initialized) {
        return 0;
    }

    /* Ensure render is initialized */
    if (!render_is_initialized()) {
        return -1;
    }

    s_initialized = 1;
    return 0;
}

/* ============================================================
 * Shutdown Font Subsystem
 * ============================================================ */
void font_shutdown(void)
{
    s_initialized = 0;
}

/* ============================================================
 * Check if Font Subsystem is Initialized
 * ============================================================ */
int font_is_initialized(void)
{
    return s_initialized;
}

/* ============================================================
 * Draw Single Character (Screen Coords)
 * ============================================================ */
void font_draw_char_screen(char c, int x, int y, uint64_t color, int scale)
{
    int char_index;
    const uint8_t *glyph;
    int row, col;
    uint8_t row_data;
    int px, py;
    int pixel_size;

    if (!s_initialized) {
        return;
    }

    /* Clamp scale */
    if (scale < 1) scale = 1;
    if (scale > 8) scale = 8;

    /* Validate character range */
    if (c < FONT_FIRST_CHAR || c > FONT_LAST_CHAR) {
        c = '?';  /* Replace invalid chars with ? */
    }

    char_index = c - FONT_FIRST_CHAR;
    glyph = s_font_data[char_index];
    pixel_size = scale;

    for (row = 0; row < FONT_CHAR_HEIGHT; row++) {
        row_data = glyph[row];
        py = y + row * scale;

        for (col = 0; col < FONT_CHAR_WIDTH; col++) {
            /* Check if pixel is set (MSB first) */
            if (row_data & (0x80 >> col)) {
                px = x + col * scale;
                render_rect_screen(px, py, pixel_size, pixel_size, color);
            }
        }
    }
}

/* ============================================================
 * Draw String (Screen Coords)
 * ============================================================ */
void font_draw_string_screen(const char *str, int x, int y, uint64_t color, int scale)
{
    int cursor_x;
    int char_width;

    if (!s_initialized || !str) {
        return;
    }

    if (scale < 1) scale = 1;
    if (scale > 8) scale = 8;

    cursor_x = x;
    char_width = FONT_CHAR_WIDTH * scale;

    while (*str) {
        if (*str == '\n') {
            /* Newline: move down and reset X */
            cursor_x = x;
            y += FONT_CHAR_HEIGHT * scale;
        } else {
            font_draw_char_screen(*str, cursor_x, y, color, scale);
            cursor_x += char_width;
        }
        str++;
    }
}

/* ============================================================
 * Draw Single Character (Normalized Coords)
 * ============================================================ */
void font_draw_char(char c, float x, float y, uint64_t color, int scale)
{
    int sx, sy;

    sx = render_norm_to_screen_x(x);
    sy = render_norm_to_screen_y(y);

    font_draw_char_screen(c, sx, sy, color, scale);
}

/* ============================================================
 * Draw String (Normalized Coords)
 * ============================================================ */
void font_draw_string(const char *str, float x, float y, uint64_t color, int scale)
{
    int sx, sy;

    sx = render_norm_to_screen_x(x);
    sy = render_norm_to_screen_y(y);

    font_draw_string_screen(str, sx, sy, color, scale);
}

/* ============================================================
 * Printf-style Drawing (Screen Coords)
 * ============================================================ */
int font_printf_screen(int x, int y, uint64_t color, int scale, const char *fmt, ...)
{
    va_list args;
    int len;

    if (!s_initialized || !fmt) {
        return 0;
    }

    va_start(args, fmt);
    len = vsnprintf(s_printf_buffer, FONT_PRINTF_BUFFER_SIZE, fmt, args);
    va_end(args);

    if (len < 0) {
        return 0;
    }

    /* Ensure null termination */
    if (len >= FONT_PRINTF_BUFFER_SIZE) {
        len = FONT_PRINTF_BUFFER_SIZE - 1;
    }
    s_printf_buffer[len] = '\0';

    font_draw_string_screen(s_printf_buffer, x, y, color, scale);

    return len;
}

/* ============================================================
 * Printf-style Drawing (Normalized Coords)
 * ============================================================ */
int font_printf(float x, float y, uint64_t color, int scale, const char *fmt, ...)
{
    va_list args;
    int len;
    int sx, sy;

    if (!s_initialized || !fmt) {
        return 0;
    }

    va_start(args, fmt);
    len = vsnprintf(s_printf_buffer, FONT_PRINTF_BUFFER_SIZE, fmt, args);
    va_end(args);

    if (len < 0) {
        return 0;
    }

    /* Ensure null termination */
    if (len >= FONT_PRINTF_BUFFER_SIZE) {
        len = FONT_PRINTF_BUFFER_SIZE - 1;
    }
    s_printf_buffer[len] = '\0';

    sx = render_norm_to_screen_x(x);
    sy = render_norm_to_screen_y(y);

    font_draw_string_screen(s_printf_buffer, sx, sy, color, scale);

    return len;
}

/* ============================================================
 * Get String Width in Pixels
 * ============================================================ */
int font_string_width(const char *str, int scale)
{
    int max_width;
    int current_width;

    if (!str) {
        return 0;
    }

    if (scale < 1) scale = 1;
    if (scale > 8) scale = 8;

    max_width = 0;
    current_width = 0;

    while (*str) {
        if (*str == '\n') {
            if (current_width > max_width) {
                max_width = current_width;
            }
            current_width = 0;
        } else {
            current_width += FONT_CHAR_WIDTH * scale;
        }
        str++;
    }

    if (current_width > max_width) {
        max_width = current_width;
    }

    return max_width;
}

/* ============================================================
 * Get String Height in Pixels
 * ============================================================ */
int font_string_height(int scale)
{
    if (scale < 1) scale = 1;
    if (scale > 8) scale = 8;

    return FONT_CHAR_HEIGHT * scale;
}
